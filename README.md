# Currency Rate Monitor

汇率监控系统 - 通过 ExchangeRate-API 定期获取指定货币对的汇率数据，当汇率满足预设条件时，通过 Resend 服务向指定邮箱发送通知邮件。

## Features

- 定期自动获取指定货币对的汇率数据
- 可配置的汇率阈值监控（上限和下限）
- 邮件通知功能（通过 Resend 服务）
- 通知冷却期机制，防止重复通知
- 完整的日志记录功能
- 模块化架构，易于扩展

## Prerequisites

- Node.js >= 18.0.0
- npm or yarn
- ExchangeRate-API key
- Resend API key

## Installation

1. Clone the repository
2. Install dependencies:

```bash
npm install
```

3. Create `.env` file from template:

```bash
cp .env.example .env
```

4. Configure your environment variables in `.env`:
   - Add your ExchangeRate-API key
   - Add your Resend API key
   - Configure email addresses
   - Set currency pair and thresholds

## Usage

### Development Mode

Run the application directly with TypeScript (no build required):

```bash
npm run dev
```

This uses `ts-node` to execute TypeScript files directly, which is ideal for development and testing.

### Production Mode

Build and run the compiled JavaScript:

```bash
# Build the project (compiles TypeScript to JavaScript in dist/)
npm run build

# Start the service
npm start
```

### Additional Scripts

```bash
# Clean build artifacts
npm run clean

# Clean and rebuild
npm run rebuild

# Run all tests
npm test

# Run only unit tests
npm run test:unit

# Run only integration tests
npm run test:integration
```

### Process Management (Production)

For production deployments, it's recommended to use a process manager like PM2:

```bash
# Install PM2 globally
npm install -g pm2

# Start the service
pm2 start dist/index.js --name currency-monitor

# Save the process list
pm2 save

# Set up PM2 to start on system boot
pm2 startup
```

### Verifying the Setup

After configuration, you can verify the system is working:

1. Start in development mode: `npm run dev`
2. Check the logs for the initial rate check
3. Verify that the system logs show successful API calls
4. Wait for a scheduled check or trigger a threshold condition to test notifications

## Configuration

All configuration is done through environment variables. See `.env.example` for available options:

- **EXCHANGE_API_KEY**: Your ExchangeRate-API key
- **BASE_CURRENCY**: Base currency code (e.g., EUR)
- **TARGET_CURRENCY**: Target currency code (e.g., CNY)
- **RATE_UPPER_THRESHOLD**: Upper threshold for rate alerts
- **RATE_LOWER_THRESHOLD**: Lower threshold for rate alerts
- **POLLING_INTERVAL_HOURS**: How often to check rates (1-24 hours)
- **RESEND_API_KEY**: Your Resend API key
- **FROM_EMAIL**: Sender email address
- **TO_EMAIL**: Recipient email address
- **NOTIFICATION_COOLDOWN_MINUTES**: Cooldown period between notifications (default: 60)
- **LOG_LEVEL**: Logging level (info, warning, error)

## Project Structure

```
currency-rate-monitor/
├── src/
│   ├── config/          # Configuration management
│   │   ├── ConfigService.ts
│   │   ├── types.ts
│   │   └── index.ts
│   ├── services/        # Business logic services
│   │   ├── RateService.ts
│   │   ├── NotificationService.ts
│   │   ├── Scheduler.ts
│   │   └── index.ts
│   ├── models/          # Data models and interfaces
│   │   ├── RateData.ts
│   │   └── index.ts
│   ├── utils/           # Utility functions
│   │   ├── Logger.ts
│   │   ├── ThresholdChecker.ts
│   │   ├── NotificationCache.ts
│   │   └── index.ts
│   ├── main.ts          # Application initialization
│   └── index.ts         # Application entry point
├── dist/                # Compiled JavaScript output (generated by build)
├── .env                 # Environment variables (not in git)
├── .env.example         # Environment variables template
├── package.json         # Project dependencies
├── tsconfig.json        # TypeScript configuration
└── README.md            # This file
```

### Build Output

When you run `npm run build`, TypeScript compiles the source code to JavaScript in the `dist/` directory:

- Source maps (`.js.map`) for debugging
- Type declarations (`.d.ts`) for TypeScript consumers
- Compiled JavaScript (`.js`) for execution

## Architecture

The system follows a modular architecture with clear separation of concerns:

- **Configuration Layer**: Manages environment variables and validation
- **Service Layer**: Contains business logic (rate fetching, notifications)
- **Infrastructure Layer**: Handles external API communication
- **Application Layer**: Orchestrates the workflow with scheduling

## Testing

The project includes comprehensive unit and integration tests.

### Unit Tests

Unit tests verify individual components in isolation:

```bash
npm run test:unit
```

Tests include:
- Configuration loading and validation
- Threshold checking logic
- Notification cache management

### Integration Tests

Integration tests verify the system's interaction with external services:

```bash
npm run test:integration
```

Tests include:
- RateService integration with ExchangeRate-API
- NotificationService integration with Resend
- End-to-end flow testing
- Error scenario handling

**Note**: Integration tests require valid API keys. See `src/services/INTEGRATION_TESTS.md` for detailed setup instructions.

### Test Configuration

For integration tests, you can use a separate test environment:

1. Copy `.env.test` to `.env.test.local`
2. Add your test API keys
3. Load the test environment: `export $(cat .env.test.local | xargs)`
4. Run integration tests: `npm run test:integration`

Some integration tests with long retry delays (5+ minutes) are skipped by default. To run them:

```bash
jest --testNamePattern="slow test"
```

## Troubleshooting

### Build Issues

If you encounter build errors:

```bash
# Clean and rebuild
npm run rebuild

# Or manually
rm -rf dist node_modules
npm install
npm run build
```

### Configuration Errors

If the application fails to start with configuration errors:

1. Verify all required environment variables are set in `.env`
2. Check that API keys are valid and not expired
3. Ensure email addresses are in correct format
4. Verify threshold values are numbers
5. Check that polling interval is between 1-24 hours

### API Connection Issues

If rate fetching fails:

1. Verify your ExchangeRate-API key is valid
2. Check your internet connection
3. Verify the API endpoint is accessible
4. Review logs for specific error messages

### Email Notification Issues

If emails are not being sent:

1. Verify your Resend API key is valid
2. Check that the FROM_EMAIL is verified in your Resend account
3. Ensure the TO_EMAIL is a valid email address
4. Check notification cooldown period hasn't been triggered
5. Review logs for email sending errors

### Logs

The application logs important events to the console. Set `LOG_LEVEL=info` in your `.env` file for detailed logging.

## License

ISC
